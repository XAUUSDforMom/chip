<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>プレイヤー別合計表示</title>
<style>
  /* 必要に応じてCSSはそのまま */
</style>
</head>
<body>

<select id="sheetSelect"></select>

<table id="dataTable">
  <thead></thead>
  <tbody></tbody>
</table>

<div id="sumBox">読み込み中...</div>

<script>
  const url = "https://script.google.com/macros/s/AKfycbzotwknkpjySFF5NTR2-WkZuiksQl9W86a7Cz_WLOv9P8JYHQgOWQfgY_D150sMHUH-/exec";

  const sheetSelect = document.getElementById("sheetSelect");
  const thead = document.querySelector("#dataTable thead");
  const tbody = document.querySelector("#dataTable tbody");
  const sumBox = document.getElementById("sumBox");
  let allData = {};

  function drawTable(sheetName) {
    thead.innerHTML = "";
    tbody.innerHTML = "";
    sumBox.textContent = "";

    if (!allData[sheetName] || allData[sheetName].length === 0) {
      tbody.innerHTML = "<tr><td colspan='100%'>データなし</td></tr>";
      sumBox.textContent = "合計データなし";
      return;
    }

    const headers = Object.keys(allData[sheetName][0]);
    const trHead = document.createElement("tr");
    headers.forEach(h => {
      const th = document.createElement("th");
      th.textContent = h;
      trHead.appendChild(th);
    });
    thead.appendChild(trHead);

    allData[sheetName].forEach(row => {
      const tr = document.createElement("tr");
      headers.forEach(h => {
        const td = document.createElement("td");
        td.textContent = row[h];
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    // 全列の合計を計算する
    const sums = {};
    allData[sheetName].forEach(row => {
      Object.keys(row).forEach(key => {
        const val = Number(row[key]) || 0;
        sums[key] = (sums[key] || 0) + val;
      });
    });

    // 合計表示用テキスト作成
    let sumText = "";
    Object.entries(sums).forEach(([player, total]) => {
      sumText += `${player} : ${total.toLocaleString()} 円\n`;
    });
    sumBox.textContent = sumText.trim();
  }

  function setupSelect() {
    sheetSelect.innerHTML = "";
    Object.keys(allData).forEach(sheetName => {
      const option = document.createElement("option");
      option.value = sheetName;
      option.textContent = sheetName;
      sheetSelect.appendChild(option);
    });
    drawTable(sheetSelect.value);
  }

  sheetSelect.addEventListener("change", () => {
    drawTable(sheetSelect.value);
  });

  fetch(url)
    .then(res => res.json())
    .then(json => {
      allData = json;
      setupSelect();
    })
    .catch(e => {
      tbody.innerHTML = "<tr><td colspan='100%'>データ取得失敗</td></tr>";
      sumBox.textContent = "合計データ取得失敗";
      console.error(e);
    });
</script>

</body>
</html>
